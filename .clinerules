# Quintessentia - AI Coding Assistant Rules

## Project Overview
Quintessentia is an AI-powered audio summarization tool built with ASP.NET Core MVC and Azure OpenAI. It downloads audio episodes, transcribes them using Whisper, summarizes the content with GPT, and generates condensed audio summaries using TTS.

## Technology Stack
- .NET 9 / C# 12
- ASP.NET Core MVC
- Azure OpenAI (Whisper, GPT, TTS)
- Azure Blob Storage
- Bootstrap 5 for UI
- Server-Sent Events (SSE) for real-time progress

## Architecture Patterns

### Service-Based Architecture
- All services implement interfaces from `Services/Contracts/`
- Services are registered in `Program.cs` with appropriate lifetimes:
  - Singleton: Storage, metadata, cache key, and storage configuration services
  - Scoped: Audio, Azure OpenAI, episode query, and progress services

### Environment-Based Service Swapping
- **Development**: Mock services (MockAzureOpenAIService, LocalFileStorageService)
- **Production**: Real Azure services (AzureOpenAIService, AzureBlobStorageService)

### Shared Utilities
- Use `Quintessentia.Utilities.TextHelper` for common text operations
- Avoid duplicating helper methods across classes

## Development Guidelines

### When Adding New Features
1. Define interface in `Services/Contracts/`
2. Implement service in `Services/`
3. Create mock version for development if calling external services
4. Register in `Program.cs` with appropriate lifetime
5. Add unit tests in `tests/Quintessentia.Tests/`

### Code Style
- Use async/await for I/O operations - avoid `.GetAwaiter().GetResult()` or `.Result`
- Implement proper error handling and logging
- Use dependency injection, avoid static dependencies
- Keep controllers thin - delegate business logic to services
- Extract shared code to `Utilities/` rather than duplicating

### Configuration
- **Never commit secrets** to source control
- Use environment variables or Azure Key Vault for production
- Use user secrets for local development
- Provide template files (e.g., `appsettings.template.json`) for required config

### Testing
- Tests located in `tests/Quintessentia.Tests/`
- Follow existing test patterns (xUnit)
- Mock external dependencies (Azure services, HTTP clients)
- Maintain 70% minimum code coverage

## Key Components

### AudioService
- Core orchestration for download, caching, and AI pipeline
- Uses SHA-256 hashing for cache keys
- Provides progress callbacks for real-time updates

### AzureOpenAIService
- Transcription (Whisper), summarization (GPT), speech generation (TTS)
- Supports custom settings per request via HttpContext.Items

### Storage Services
- IStorageService: File storage abstraction (local or Azure Blob)
- IMetadataService: Metadata persistence (local JSON or Azure Blob)
- Uses lazy initialization pattern to avoid sync-over-async

## Files to Avoid Modifying
- `wwwroot/lib/` - Third-party libraries
- `bin/`, `obj/` - Build artifacts

## Build and Run
```bash
dotnet build
dotnet run --project src/Quintessentia
```

## Additional Resources
- [README](readme.md) - Project overview
- [Anti-Patterns](ANTI-PATTERNS.md) - Known issues and recommendations
- [Code Coverage](docs/CODE_COVERAGE.md) - Coverage guidelines
